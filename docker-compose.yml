services:
  db:
    image: mysql:8.0
    container_name: petcare-db
    environment:
      MYSQL_DATABASE: petcare
      MYSQL_USER: pet
      MYSQL_PASSWORD: pet
      MYSQL_ROOT_PASSWORD: root
    ports:
 feat/backend-auth-jwt
      - "3307:3306"
    command: ["mysqld", "--default-authentication-plugin=mysql_native_password", "--sql-mode="]
    volumes:
      - db_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "-upet", "-ppet"]
      interval: 5s
      timeout: 3s
      retries: 20
    restart: unless-stopped

  backend:
    build: ./backend
    container_name: petcare-backend
    depends_on:
      db:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: docker
    ports:
      - "8080:8080"
    restart: unless-stopped

  frontend:
    build: ./frontend
    container_name: petcare-frontend
    depends_on:
      - backend
    working_dir: /app
    environment:
      # no Windows ajuda o HMR do Vite
      CHOKIDAR_USEPOLLING: "true"
    volumes:
      # seu código local fica montado no container
      - ./frontend:/app
      # mantém node_modules dentro do container (evita conflito no Windows)
      - /app/node_modules
    ports:
      - "5173:5173"
    # instala deps se estiver vazio e depois roda o Vite
    command: >
      sh -lc "
      if [ ! -d node_modules ] || [ ! -f node_modules/.installed ]; then
        if [ -f package-lock.json ]; then npm ci; else npm install; fi &&
        mkdir -p node_modules && echo ok > node_modules/.installed;
      fi &&
      npm run dev
      "
    restart: unless-stopped

volumes:
  db_data:
